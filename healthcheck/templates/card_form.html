{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Health Check Voting</title>
    <link rel="stylesheet" href="{% static 'healthcheck/css/styles.css' %}">
    <script src="https://kit.fontawesome.com/b4269277b2.js" crossorigin="anonymous"></script>
    <style>
        .voting-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .page-header {
            background-color: #333;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
        }
        
        .team-selector {
            margin-bottom: 30px;
        }
        
        .team-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .health-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
        }
        
        .card-title {
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .voting-options {
            display: flex;
            justify-content: space-between;
        }
        
        .vote-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .vote-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-bottom: 5px;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        
        .vote-circle:hover {
            transform: scale(1.1);
        }
        
        .vote-circle.selected {
            border: 2px solid #333;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .vote-circle.green {
            background-color: #32CD32;
        }
        
        .vote-circle.amber {
            background-color: #FFA500;
        }
        
        .vote-circle.red {
            background-color: #FF4136;
        }
        
        .vote-label {
            font-size: 12px;
            text-align: center;
        }
        
        .submit-container {
            text-align: center;
        }
        
        .submit-btn {
            background-color: #0077c8;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .submit-btn:hover {
            background-color: #005fa3;
        }
    </style>
</head>
<body>
    {% include 'home-button.html' %}
    
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="{% static 'healthcheck/images/sky.png' %}" alt="Sky Logo">
            </div>
            
        </div>
    
        <form id="voteForm" method="POST">
            {% csrf_token %}


            <div class="selectors" style="margin-bottom: 20px; display: flex; gap: 15px;">
                <div style="flex-grow: 1;">
                    <label for="session-select-id" style="display: block; margin-bottom: 5px; font-weight: bold;">Session:</label>
                    <select id="session-select-id" class="session-select input-field" name="session" required>
                        <option value="">Select a Session</option>
                        {% for session in sessions %}
                            <option value="{{ session.id }}" {% if session.id|stringformat:"s" == selected_session_id %}selected{% endif %}>
                                {{ session.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex-grow: 1;">
                    <label for="team-select-id" style="display: block; margin-bottom: 5px; font-weight: bold;">Team:</label>
                    <select id="team-select-id" class="team-select input-field" name="team" required>
                        <option value="">Select Your Team</option>
                        {% for team in teams %}
                            <option value="{{ team.id }}"
                                    {% if team.id|stringformat:"s" == selected_team_id %}
                                        selected
                                    {% elif not selected_team_id and team.id == default_team_id %}
                                        selected
                                    {% endif %}>
                                {{ team.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="health-checks">
                {% for card_type, card_name in card_types %}
                <div class="health-check-card" data-card="{{ card_type }}">
                    <h3 class="card-title">{{ card_name }}</h3>
                    <div class="voting-options">
                        <button type="button" class="vote-button good" data-value="good">
                            <i class="fas fa-smile vote-icon"></i>
                            <span class="vote-label">Good</span>
                        </button>
                        <button type="button" class="vote-button neutral" data-value="neutral">
                            <i class="fas fa-meh vote-icon"></i>
                            <span class="vote-label">Neutral</span>
                        </button>
                        <button type="button" class="vote-button needs-improvement" data-value="needs_improvement">
                            <i class="fas fa-frown vote-icon"></i>
                            <span class="vote-label">Needs Improvement</span>
                        </button>
                    </div>
                    <div class="progress-tracker">
                        <p>Is this improving?</p>
                        <div class="progress-options">
                            <button type="button" class="progress-button improving" data-progress="improving">
                                <i class="fas fa-arrow-up"></i>
                                <span>Improving</span>
                            </button>
                            <button type="button" class="progress-button stable" data-progress="stable">
                                <i class="fas fa-equals"></i>
                                <span>Stable</span>
                            </button>
                            <button type="button" class="progress-button declining" data-progress="declining">
                                <i class="fas fa-arrow-down"></i>
                                <span>Declining</span>
                            </button>
                        </div>
                    </div>
                    <div class="comments-section">
                        <textarea name="comments_{{ card_type }}" placeholder="Add comments (optional)"></textarea>
                    </div>
                    <input type="hidden" name="vote_{{ card_type }}" id="vote_{{ card_type }}">
                    <input type="hidden" name="progress_{{ card_type }}" id="progress_{{ card_type }}">
                </div>
                {% endfor %}
            </div>
    
            <button type="submit" class="submit-button">Submit Vote</button>
        </form>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.vote-button').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.health-check-card');
                const cardType = card.dataset.card;
                const voteInput = document.getElementById(`vote_${cardType}`);
                
                const siblings = this.parentElement.querySelectorAll('.vote-button');
                siblings.forEach(sib => sib.classList.remove('selected'));
                
                this.classList.add('selected');
                
                voteInput.value = this.dataset.value;
            });
        });
    
        document.querySelectorAll('.progress-button').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.health-check-card');
                const cardType = card.dataset.card;
                const progressInput = document.getElementById(`progress_${cardType}`);
                
                const siblings = this.parentElement.querySelectorAll('.progress-button');
                siblings.forEach(sib => sib.classList.remove('selected'));
                
                this.classList.add('selected');
                
                progressInput.value = this.dataset.progress;
            });
        });
    
        document.getElementById('voteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const session = document.querySelector('.session-select').value;
            const team = document.querySelector('.team-select').value;
            
            if (!session || !team) {
                alert('Please select both a session and a team');
                return;
            }
            
            let isValid = true;
            document.querySelectorAll('.health-check-card').forEach(card => {
                const cardType = card.dataset.card;
                const vote = document.getElementById(`vote_${cardType}`).value;
                const progress = document.getElementById(`progress_${cardType}`).value;
                
                if (!vote || !progress) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                alert('Please vote and indicate progress for all cards');
                return;
            }
            
            this.submit();
        });
    
        function loadExistingVotes() {
            const session = document.querySelector('.session-select').value;
            const team = document.querySelector('.team-select').value;
            
            if (session && team) {
                fetch(`/api/votes/?session=${session}&team=${team}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(vote => {
                            const card = document.querySelector(`.health-check-card[data-card="${vote.card_type}"]`);
                            if (card) {
                                const voteButton = card.querySelector(`.vote-button[data-value="${vote.vote}"]`);
                                if (voteButton) {
                                    voteButton.click();
                                }
                                
                                const progressButton = card.querySelector(`.progress-button[data-progress="${vote.progress}"]`);
                                if (progressButton) {
                                    progressButton.click();
                                }
                                
                                const comments = card.querySelector('textarea');
                                if (comments) {
                                    comments.value = vote.comments || '';
                                }
                            }
                        });
                    });
            }
        }
    
        document.querySelector('.session-select').addEventListener('change', loadExistingVotes);
        document.querySelector('.team-select').addEventListener('change', loadExistingVotes);
    });
    </script>
</body>
</html>
