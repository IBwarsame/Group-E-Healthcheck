{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Register</title>
        <link
            rel="stylesheet"
            href="{% static 'healthcheck/css/styles.css' %}"
        />
        <script
            src="https://kit.fontawesome.com/b4269277b2.js"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <div class="container">
            <div class="register-container">
                <img
                    src="{% static 'healthcheck/images/sky.png' %}"
                    alt="Sky Logo"
                    class="logo"
                />
                <h1>Register</h1>

                <form method="post" id="registrationForm">
                    {% csrf_token %} {% if form.errors %}
                    <div class="error-message">
                        {% for field in form %} {% for error in field.errors %}
                        <p>{{ error }}</p>
                        {% endfor %} {% endfor %}
                    </div>
                    {% endif %}

                    <div class="input-group">
                        <label for="{{ form.username.id_for_label }}"
                            >Username</label
                        >
                        {{ form.username }}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.email.id_for_label }}">Email</label>
                        {{ form.email }} {% if form.email.errors %}
                        <div class="error-message">
                            {% for error in form.email.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.first_name.id_for_label }}"
                            >First Name</label
                        >
                        {{ form.first_name }} {% if form.first_name.errors %}
                        <div class="error-message">
                            {% for error in form.first_name.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.last_name.id_for_label }}"
                            >Last Name</label
                        >
                        {{ form.last_name }} {% if form.last_name.errors %}
                        <div class="error-message">
                            {% for error in form.last_name.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.role.id_for_label }}">Role</label>
                        <div class="select-wrapper">{{ form.role }}</div>
                        {% if form.role.errors %}
                        <div class="error-message">
                            {% for error in form.role.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div id="dept-team-container">
                        <div class="input-group">
                            <label for="{{ form.department.id_for_label }}">{{ form.department.label }}</label>
                            <div class="select-wrapper">{{ form.department }}</div>
                            {% if form.department.help_text %}
                                <p class="help-text">{{ form.department.help_text }}</p>
                            {% endif %}
                        </div>

                        <div class="input-group">
                            <label for="{{ form.team.id_for_label }}">{{ form.team.label }}</label>
                            <div class="select-wrapper">{{ form.team }}</div>
                            {% if form.team.help_text %}
                                <p class="help-text">{{ form.team.help_text }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="{{ form.password1.id_for_label }}"
                            >Password</label
                        >
                        {{ form.password1 }}
                        <div class="password-strength">
                            <div class="strength-meter"></div>
                        </div>
                        <div class="password-requirements">
                            <div class="requirement" data-requirement="length">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                At least 8 characters
                            </div>
                            <div class="requirement" data-requirement="number">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains a number
                            </div>
                            <div
                                class="requirement"
                                data-requirement="uppercase"
                            >
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains uppercase letter
                            </div>
                            <div
                                class="requirement"
                                data-requirement="lowercase"
                            >
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains lowercase letter
                            </div>
                            <div class="requirement" data-requirement="special">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains special character
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="{{ form.password2.id_for_label }}"
                            >Confirm Password</label
                        >
                        {{ form.password2 }}
                    </div>
                    <div class="login-button-group">
                        <button type="submit" class="btn register-btn">
                            Register
                        </button>
                    </div>

                    <div class="login-link">
                        Already have an account?
                        <a href="{% url 'login' %}">Login here</a>
                    </div>
                </form>
            </div>
        </div>

        {{ teams_by_dept_json|json_script:"teams-by-dept-data" }}

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const roleSelect = document.getElementById('{{ form.role.auto_id }}');
                const departmentSelect = document.getElementById('{{ form.department.auto_id }}');
                const teamSelect = document.getElementById('{{ form.team.auto_id }}');
                const deptTeamContainer = document.getElementById('dept-team-container');
                const teamsDataElement = document.getElementById('teams-by-dept-data');
                let teamsByDept = {};

                const initialTeamPlaceholder = "Select a department first";
                const initialDeptRequired = departmentSelect.required;
                const initialTeamRequired = teamSelect.required;

                function disableTeamSelect() {
                    teamSelect.disabled = true;
                    while (teamSelect.options.length > 1) { teamSelect.remove(1); }
                    if (teamSelect.options.length === 0) {
                        const placeholderOption = new Option(initialTeamPlaceholder, "");
                        teamSelect.add(placeholderOption);
                    } else {
                        teamSelect.options[0].text = initialTeamPlaceholder;
                        teamSelect.options[0].value = "";
                    }
                    teamSelect.value = "";
                }

                if (teamsDataElement) {
                    try { teamsByDept = JSON.parse(teamsDataElement.textContent); } catch (e) { console.error("Error parsing teams-by-dept data:", e); }
                } else { console.error("Could not find teams-by-dept-data script tag."); }

                function toggleDeptTeamVisibility() {
                    const selectedRole = roleSelect.value;
                    console.log("Role changed to:", selectedRole);
                    if (selectedRole === 'seniorManager') {
                        deptTeamContainer.classList.add('hidden-field');
                        departmentSelect.required = false;
                        teamSelect.required = false;
                        departmentSelect.value = '';
                        disableTeamSelect();
                        console.log("Hiding Dept/Team fields for Senior Manager");
                    } else {
                        deptTeamContainer.classList.remove('hidden-field');
                        departmentSelect.required = initialDeptRequired;
                        teamSelect.required = initialTeamRequired;
                        updateTeamOptions();
                        console.log("Showing Dept/Team fields");
                    }
                }

                function updateTeamOptions() {
                    if (deptTeamContainer.classList.contains('hidden-field')) { disableTeamSelect(); return; }
                    const selectedDeptId = departmentSelect.value;
                    console.log("Department changed to:", selectedDeptId);
                    while (teamSelect.options.length > 1) { teamSelect.remove(1); }
                    teamSelect.options[0].text = "-- Select your team --";
                    teamSelect.options[0].value = "";
                    teamSelect.value = "";
                    if (selectedDeptId && teamsByDept[selectedDeptId]) {
                        teamSelect.disabled = false;
                        const teams = teamsByDept[selectedDeptId];
                        teams.forEach(function(team) { teamSelect.add(new Option(team.name, team.id)); });
                        console.log("Populated teams for dept", selectedDeptId, teams);
                    } else {
                        disableTeamSelect();
                        console.log("Disabling team select.");
                    }
                }

                disableTeamSelect();
                toggleDeptTeamVisibility();

                if (roleSelect) { roleSelect.addEventListener('change', toggleDeptTeamVisibility); } else { console.error("Role select element not found."); }
                if (departmentSelect) { departmentSelect.addEventListener('change', updateTeamOptions); } else { console.error("Department select element not found."); }



                const passwordInput = document.getElementById(
                    "{{ form.password1.auto_id }}"
                );
                const requirements = {
                    length: (str) => str.length >= 8,
                    number: (str) => /[0-9]/.test(str),
                    uppercase: (str) => /[A-Z]/.test(str),
                    lowercase: (str) => /[a-z]/.test(str),
                    special: (str) => /[^A-Za-z0-9]/.test(str),
                };

                const strengthMeter = document.querySelector(".strength-meter");

                passwordInput.addEventListener("input", function (e) {
                    const password = e.target.value;
                    let metRequirements = 0;

                    Object.entries(requirements).forEach(
                        ([requirement, validateFunc]) => {
                            const metRequirement = validateFunc(password);
                            const requirementElement = document.querySelector(
                                `[data-requirement="${requirement}"]`
                            );

                            if (metRequirement) {
                                requirementElement.classList.add("met");
                                metRequirements++;
                            } else {
                                requirementElement.classList.remove("met");
                            }
                        }
                    );

                    const strength =
                        (metRequirements / Object.keys(requirements).length) *
                        100;
                    strengthMeter.style.width = `${strength}%`;

                    if (strength <= 25) {
                        strengthMeter.style.backgroundColor = "#ff4d4d";
                    } else if (strength <= 50) {
                        strengthMeter.style.backgroundColor = "#ffd700";
                    } else if (strength <= 75) {
                        strengthMeter.style.backgroundColor = "#90EE90";
                    } else {
                        strengthMeter.style.backgroundColor = "#28a745";
                    }
                });
            });
        </script>
    </body>
</html>
