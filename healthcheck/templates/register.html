{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Register</title>
        <link
            rel="stylesheet"
            href="{% static 'healthcheck/css/styles.css' %}"
        />
        <script
            src="https://kit.fontawesome.com/b4269277b2.js"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <div class="container">
            <div class="register-container">
                <img
                    src="{% static 'healthcheck/images/sky.png' %}"
                    alt="Sky Logo"
                    class="logo"
                />
                <h1>Register</h1>

                <form method="post" id="registrationForm">
                    {% csrf_token %} {% if form.errors %}
                    <div class="error-message">
                        {% for field in form %} {% for error in field.errors %}
                        <p>{{ error }}</p>
                        {% endfor %} {% endfor %}
                    </div>
                    {% endif %}

                    <div class="input-group">
                        <label for="{{ form.username.id_for_label }}"
                            >Username</label
                        >
                        {{ form.username }}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.email.id_for_label }}">Email</label>
                        {{ form.email }} {% if form.email.errors %}
                        <div class="error-message">
                            {% for error in form.email.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.first_name.id_for_label }}"
                            >First Name</label
                        >
                        {{ form.first_name }} {% if form.first_name.errors %}
                        <div class="error-message">
                            {% for error in form.first_name.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.last_name.id_for_label }}"
                            >Last Name</label
                        >
                        {{ form.last_name }} {% if form.last_name.errors %}
                        <div class="error-message">
                            {% for error in form.last_name.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="input-group">
                        <label for="{{ form.role.id_for_label }}">Role</label>
                        <div class="select-wrapper">{{ form.role }}</div>
                        {% if form.role.errors %}
                        <div class="error-message">
                            {% for error in form.role.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div id="dept-team-container">
                        <div class="input-group">
                            <label for="{{ form.department.id_for_label }}">{{ form.department.label }}</label>
                            <div class="select-wrapper">{{ form.department }}</div>
                            {% if form.department.help_text %}
                                <p class="help-text">{{ form.department.help_text }}</p>
                            {% endif %}
                        </div>
                        <div class="input-group" id="team-input-group"> {# Added ID here #}
                            <label for="{{ form.team.id_for_label }}">{{ form.team.label }}</label>
                            <div class="select-wrapper">{{ form.team }}</div>
                            {% if form.team.help_text %}
                                <p class="help-text">{{ form.team.help_text }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="{{ form.password1.id_for_label }}">Password</label>
                        {{ form.password1 }}
                        <div class="password-strength">
                            <div class="strength-meter"></div>
                        </div>
                        <div class="password-requirements">
                            <div class="requirement" data-requirement="length">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                At least 8 characters
                            </div>
                            <div class="requirement" data-requirement="number">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains a number
                            </div>
                            <div
                                class="requirement"
                                data-requirement="uppercase"
                            >
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains uppercase letter
                            </div>
                            <div
                                class="requirement"
                                data-requirement="lowercase"
                            >
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains lowercase letter
                            </div>
                            <div class="requirement" data-requirement="special">
                                <span class="check-icon"
                                    ><i class="fa-solid fa-check"></i
                                ></span>
                                <span class="cross-icon"
                                    ><i class="fa-solid fa-xmark"></i
                                ></span>
                                Contains special character
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="{{ form.password2.id_for_label }}"
                            >Confirm Password</label
                        >
                        {{ form.password2 }}
                    </div>
                    <div class="login-button-group">
                        <button type="submit" class="btn register-btn">
                            Register
                        </button>
                    </div>

                    <div class="login-link">
                        Already have an account?
                        <a href="{% url 'login' %}">Login here</a>
                    </div>
                </form>
            </div>
        </div>

        {{ teams_by_dept_json|json_script:"teams-by-dept-data" }}

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const roleSelect = document.getElementById('{{ form.role.auto_id }}');
                const departmentSelect = document.getElementById('{{ form.department.auto_id }}');
                const teamSelect = document.getElementById('{{ form.team.auto_id }}');
                const deptTeamContainer = document.getElementById('dept-team-container');
                const teamInputGroup = document.getElementById('team-input-group');
                const teamsDataElement = document.getElementById('teams-by-dept-data');
                let teamsByDept = {};
        
                const initialTeamPlaceholder = "Select a department first";
                const selectTeamPlaceholder = "Select your team";
                const initialDeptRequired = departmentSelect ? departmentSelect.required : false;
                const initialTeamRequired = teamSelect ? teamSelect.required : false;
        
                function setTeamOptions(options) {
                    if (!teamSelect) return;
                    teamSelect.innerHTML = '';
                    const placeholder = new Option(selectTeamPlaceholder, "");
                    teamSelect.add(placeholder);
                    options.forEach(function(team) {
                        const option = new Option(team.name, team.id);
                        teamSelect.add(option);
                    });
                    teamSelect.value = "";
                }
        
                function disableTeamSelect(message = initialTeamPlaceholder) {
                    if (!teamSelect) return;
                    teamSelect.disabled = true;
                    teamSelect.innerHTML = '';
                    const placeholder = new Option(message, "");
                    teamSelect.add(placeholder);
                    teamSelect.value = "";
                }
        
                if (teamsDataElement) {
                    try {
                        teamsByDept = JSON.parse(JSON.parse(teamsDataElement.textContent));
                    } catch (e) {
                        console.error("Error parsing teams-by-dept data:", e);
                    }
                } else {
                     console.error("Could not find teams-by-dept-data script tag.");
                }
        
                function handleRoleChange() {
                    if (!roleSelect || !departmentSelect || !teamSelect || !deptTeamContainer || !teamInputGroup) {
                        console.error("One or more form elements not found for role handling.");
                        return;
                    }
                    const selectedRole = roleSelect.value;
        
                    const noTeamDeptRoles = ['seniorManager', 'departmentLeader'];
        
                    if (noTeamDeptRoles.includes(selectedRole)) {
                        deptTeamContainer.classList.add('hidden-field');
                        departmentSelect.required = false;
                        teamSelect.required = false;
                        departmentSelect.value = '';
                        disableTeamSelect("N/A for this role");
                    } else {
                        deptTeamContainer.classList.remove('hidden-field');
                        departmentSelect.required = initialDeptRequired;
                        teamSelect.required = initialTeamRequired;
                        updateTeamOptions();
                    }
                }

                function updateTeamOptions() {
                    if (!departmentSelect || !teamSelect || !teamInputGroup || !deptTeamContainer) {
                        console.error("Dept or Team select not found for updating options.");
                        return;
                    }
                    if (deptTeamContainer.classList.contains('hidden-field')) {
                        disableTeamSelect("N/A for this role");
                        return;
                    }
        
                    const selectedDeptId = departmentSelect.value;
        
                    if (selectedDeptId && teamsByDept[selectedDeptId] && teamsByDept[selectedDeptId].length > 0) {
                        teamSelect.disabled = false;
                        setTeamOptions(teamsByDept[selectedDeptId]);
                        teamInputGroup.classList.remove('hidden-field');
                    } else if (selectedDeptId) {
                        disableTeamSelect("No teams in selected department");
                        teamInputGroup.classList.remove('hidden-field');
                    }
                     else {
                        disableTeamSelect(initialTeamPlaceholder);
                        teamInputGroup.classList.remove('hidden-field');
                    }
                }
        
                if (teamSelect) {
                     disableTeamSelect();
                }
                if (roleSelect) {
                    handleRoleChange();
                }
        
        
                if (roleSelect) { roleSelect.addEventListener('change', handleRoleChange); } else { console.error("Role select element not found."); }
                if (departmentSelect) { departmentSelect.addEventListener('change', updateTeamOptions); } else { console.error("Department select element not found."); }
        
                const passwordInput = document.getElementById("{{ form.password1.auto_id }}");
                if (passwordInput) {
                    const requirements = {
                        length: (str) => str.length >= 8,
                        number: (str) => /[0-9]/.test(str),
                        uppercase: (str) => /[A-Z]/.test(str),
                        lowercase: (str) => /[a-z]/.test(str),
                        special: (str) => /[^A-Za-z0-9]/.test(str),
                    };
                    const strengthMeter = document.querySelector(".strength-meter");
        
                    passwordInput.addEventListener("input", function (e) {
                        const password = e.target.value;
                        let metRequirements = 0;
                        Object.entries(requirements).forEach(
                            ([requirement, validateFunc]) => {
                                const requirementElement = document.querySelector(`[data-requirement="${requirement}"]`);
                                if (!requirementElement) return;
                                const metRequirement = validateFunc(password);
                                if (metRequirement) {
                                    requirementElement.classList.add("met");
                                    metRequirements++;
                                } else {
                                    requirementElement.classList.remove("met");
                                }
                            }
                        );
                        if (strengthMeter) {
                            const strength = (metRequirements / Object.keys(requirements).length) * 100;
                            strengthMeter.style.width = `${strength}%`;
                            if (strength <= 25) strengthMeter.style.backgroundColor = "#ff4d4d";
                            else if (strength <= 50) strengthMeter.style.backgroundColor = "#ffd700";
                            else if (strength <= 75) strengthMeter.style.backgroundColor = "#90EE90";
                            else strengthMeter.style.backgroundColor = "#28a745";
                        }
                    });
                }
        
            });
        </script>
        
    </body>
</html>
